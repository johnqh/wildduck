# WildDuck AI Development Context

## Project Overview
WildDuck is a distributed, stateless email server built with Node.js and MongoDB. It implements IMAP4, POP3, LMTP protocols and provides a RESTful API for management operations. The project features blockchain-based authentication for Web3 integration.

## Current State (v6.10.0)
- **Address Management**: Disabled POST/PUT/DELETE operations for user addresses
- **Authentication**: Blockchain signature verification via external indexer service
- **Validation**: Username validation through indexer during user creation
- **Integration**: Updated to use indexer API endpoints v2 paths

## Architecture Quick Map

### Entry Points
```
server.js (master process)
├── worker.js (protocol servers)
├── imap.js (IMAP4 server)
├── pop3.js (POP3 server)
├── lmtp.js (LMTP server)
├── api.js (REST API)
└── acme.js (SSL management)
```

### Core Libraries (lib/)
```
lib/
├── user-handler.js          # User management, blockchain auth
├── message-handler.js       # Email processing, storage
├── mailbox-handler.js       # IMAP folder operations
├── signature-verifier.js    # Blockchain signature validation
├── blockchain-validator.js  # Address format validation
├── name-resolver.js         # ENS/SNS resolution
├── attachment-storage.js    # File deduplication
└── api/                     # REST API endpoints
```

### Data Storage
- **MongoDB**: Primary data store (users, messages, mailboxes)
- **Redis**: Sessions, caching, rate limiting, pub/sub
- **GridFS**: Large attachment storage with deduplication
- **Elasticsearch**: Optional full-text search

## Blockchain Authentication System

### Supported Identity Types
- **EVM Addresses**: 0x... (Ethereum-compatible)
- **Base64 EVM**: Compact representation
- **Solana Addresses**: Base58-encoded public keys
- **ENS Names**: .eth, .box domains
- **SNS Names**: .sol domains

### Authentication Flow
1. **Username Validation** → `indexer:/api/addresses/validate/:address`
2. **Address Resolution** → ENS/SNS → owner address
3. **Signature Verification** → `indexer:/api/signature/verify`
4. **Account Auto-creation** → for valid blockchain identifiers

### Integration Points
- **Indexer Service**: `http://localhost:42069` (configurable)
- **Endpoints Used**:
  - `GET /api/addresses/validate/:address` - Username validation
  - `POST /api/signature/verify` - Signature verification

## Common Development Patterns

### Handler Class Pattern
```javascript
class XHandler {
    constructor(options) {
        this.database = options.database;
        this.users = options.users;
    }
    
    async asyncMethod(params) {
        // Always use async/await for new code
        // Maintain callback fallbacks for compatibility
    }
}
```

### API Endpoint Pattern
```javascript
server.post({
    path: '/api/endpoint',
    validationObjs: {
        requestBody: { /* Joi schema */ },
        pathParams: { /* Joi schema */ },
        response: { /* Joi schema */ }
    }
}, tools.responseWrapper(async (req, res) => {
    // Permission checks
    req.validate(roles.can(req.role).createAny('resource'));
    
    // Business logic
    const result = await handler.doSomething();
    
    // Consistent response
    return res.json({ success: true, data: result });
}));
```

### Error Handling Pattern
```javascript
let err = new Error('Description');
err.code = 'MACHINE_READABLE_CODE';
err.responseCode = 400; // HTTP status
throw err;
```

## Configuration System
- **Base Config**: `config/default.toml`
- **Environment**: `.env` and `.env.local` files
- **Access**: `config.section.subsection.key`
- **Validation**: `wild-config` library with type checking

## Testing Approach
- **Unit Tests**: `test/` directory with Mocha
- **Integration**: Requires MongoDB + Redis
- **Commands**:
  - `npm test` - Full suite (drops test DB)
  - `npm run runtest` - Skip DB setup
  - `NODE_ENV=test grunt mochaTest:api` - API only

## AI Development Guidelines

### Quick Start Commands
```bash
# Development
npm start                    # Start server
npm run printconf           # Validate configuration
npm test                    # Run all tests
grunt eslint                # Check code quality

# Blockchain Testing
NODE_ENV=test npx mocha test --grep "signature"
node scripts/ai-dev-helper.js  # Environment diagnostics
```

### File Modification Checklist
1. **Read existing code** - Understand patterns first
2. **Follow conventions** - Use established patterns
3. **Check dependencies** - Verify libraries are available
4. **Handle errors** - Use consistent error patterns
5. **Test changes** - Run relevant test suites
6. **Lint code** - Ensure style compliance

### Common AI Tasks
- **Feature Addition**: Follow handler patterns in `lib/`
- **API Development**: Use Joi validation + error schemas
- **Database Ops**: Use handler classes with proper error handling
- **Authentication**: Leverage blockchain auth system
- **Configuration**: Use wild-config with environment fallbacks

### Debugging Helpers
- **Dev Helper**: `node scripts/ai-dev-helper.js`
- **Config Validation**: `NODE_CONFIG_ONLY=true node server.js`
- **Test Specific Features**: `npm run test:auth` for blockchain auth

## Key Integration Points

### External Services
- **mail_box_indexer**: Signature verification (localhost:42069)
- **MongoDB**: Primary data store
- **Redis**: Caching and sessions
- **Elasticsearch**: Optional search indexing

### Protocol Servers
- **IMAP**: Port 9993 (SSL)
- **POP3**: Port 9995 (SSL)  
- **LMTP**: Port 2424 (local)
- **API**: Port 8080 (HTTP)

## Current Limitations (v6.10.0)
- **Address Management**: POST/PUT/DELETE disabled for `/users/:user/addresses`
- **Default Mailboxes**: Auto-creation removed (manual creation required)
- **Dependencies**: Requires external indexer service for blockchain features

## Recent Changes Log
- v6.10.0: Updated indexer endpoints, disabled address management
- v6.9.0: Added blockchain authentication system
- v6.8.x: Enhanced security and validation

This context file should be updated when major architectural changes occur.